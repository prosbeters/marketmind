<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketMind Ultimate - Intelligence 2026 Vision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --gold: #d4af37;
            --navy-pitch: #02040a;
            --glass: rgba(10, 15, 30, 0.85);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--navy-pitch);
            color: #f8fafc;
            overflow-x: hidden;
        }

        .font-luxury { font-family: 'Playfair Display', serif; }

        /* Scrollbar Stealth Premium */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold); }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .gold-gradient-text {
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-luxury {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(212, 175, 55, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-luxury:hover {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.05);
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.1);
            transform: translateY(-3px);
        }

        .btn-gold {
            background: linear-gradient(135deg, #d4af37 0%, #b38728 100%);
            color: #000;
            font-weight: 800;
            transition: all 0.3s ease;
        }

        .btn-gold:hover { transform: scale(1.02); box-shadow: 0 0 35px rgba(212, 175, 55, 0.4); }

        /* Mencegah Kolom Putih & Warna Input Global */
        input, select, textarea {
            background-color: #000000 !important;
            background: #000000 !important;
            border: 1px solid rgba(212, 175, 55, 0.2) !important;
            color: #ffffff !important;
            outline: none !important;
            appearance: none;
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.3) !important;
        }

        /* Override Autofill Browser */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 1000px #000000 inset !important;
            -webkit-text-fill-color: #ffffff !important;
            transition: background-color 5000s ease-in-out 0s;
        }

        /* Tooltip Master */
        .info-tooltip {
            display: none;
            position: absolute;
            top: 100%;
            margin-top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 16rem;
            padding: 1.5rem;
            background: #000;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 1.5rem;
            z-index: 120;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .info-trigger-area:hover .info-tooltip {
            display: block;
        }

        /* Formatting Hasil Analisa */
        #res-body { line-height: 1.8; color: #cbd5e1; text-align: justify; font-size: 1rem; }
        #res-body h2 { border-bottom: 2px solid rgba(212, 175, 55, 0.2); padding-bottom: 0.5rem; font-size: 1.5rem; color: var(--gold); margin: 2rem 0 1rem; }
        #res-body ul { list-style: none; padding: 0; margin-bottom: 1.5rem; }
        #res-body li { position: relative; padding-left: 2rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.02); padding-bottom: 1rem; }
        #res-body li::before { content: '‚úì'; position: absolute; left: 0; color: var(--gold); font-weight: bold; font-size: 1.2rem; }
        #res-body strong { color: var(--gold); font-weight: 800; }
        
        .spinner-luxury {
            width: 50px; height: 50px;
            border: 3px solid rgba(212, 175, 55, 0.1);
            border-top: 3px solid var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pdf-page-header { display: none; padding-bottom: 20px; border-bottom: 2px solid var(--gold); margin-bottom: 30px; }
        .watermark {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 8rem; font-weight: 900; color: rgba(0, 0, 0, 0.03);
            white-space: nowrap; pointer-events: none; z-index: -1; text-transform: uppercase;
        }
        .tutorial-overlay { background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); }
    </style>
</head>
<body class="selection:bg-gold selection:text-black">

    <!-- LOGIN SUITE -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-6 transition-opacity duration-500 bg-black">
        <div class="w-full max-w-lg glass-panel rounded-[2.5rem] p-12 shadow-2xl relative overflow-hidden text-center border border-white/5">
            <div class="mb-12 text-shadow">
                <h1 class="text-6xl font-luxury gold-gradient-text mb-2 tracking-tighter">MarketMind</h1>
                <p class="text-slate-500 uppercase tracking-[0.5em] text-[9px] font-extrabold">Sahabat Bisnis Bapak</p>
            </div>

            <form id="login-form" class="space-y-5 text-left" autocomplete="off">
                <div class="space-y-1.5">
                    <label class="text-[9px] uppercase font-bold text-slate-500 ml-1 tracking-[0.2em]">Work Email</label>
                    <input type="email" id="login-email" required class="w-full rounded-2xl px-5 py-4 text-sm" placeholder="Contoh: ceo@bisnis.com" autocomplete="email">
                </div>
                <div class="space-y-1.5">
                    <label class="text-[9px] uppercase font-bold text-slate-500 ml-1 tracking-[0.2em]">Akses Token</label>
                    <input type="password" id="login-password" required class="w-full rounded-2xl px-5 py-4 text-sm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                </div>
                <div class="pt-2 text-shadow">
                    <div class="flex justify-between items-center mb-1.5">
                        <label class="text-[9px] uppercase font-bold text-slate-500 ml-1 tracking-[0.2em]">Kunci AI Gemini</label>
                        <button type="button" id="delete-api-btn" class="hidden text-[9px] text-red-500 hover:text-red-400 font-bold uppercase">Revoke</button>
                    </div>
                    <input type="password" id="api-key-input" class="w-full rounded-2xl px-5 py-4 text-sm" placeholder="Tempel kunci AI di sini" autocomplete="new-password">
                    
                    <button type="button" onclick="window.toggleTutorial(true)" class="mt-2 text-[9px] font-bold text-gold/60 hover:text-gold uppercase tracking-widest flex items-center gap-1 transition-all">
                        <span>‚ùî Cara mendapatkan kunci AI?</span>
                    </button>
                </div>
                <button id="login-btn" type="submit" class="w-full btn-gold py-5 rounded-2xl uppercase tracking-[0.3em] text-xs flex items-center justify-center gap-3 mt-8 transition-all shadow-2xl">
                    <span id="login-text">Masuk ke Ruang Diskusi</span>
                    <div id="login-loader" class="hidden w-4 h-4 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
                </button>
                <p id="login-error" class="text-red-500 text-[9px] text-center font-bold uppercase mt-5 h-4"></p>
            </form>
            <p class="mt-12 text-[8px] font-bold text-slate-700 tracking-[0.4em] uppercase">Intelligence For Market Leaders ¬© 2026</p>
        </div>
    </div>

    <!-- CONFLICT SCREEN -->
    <div id="conflict-screen" class="fixed inset-0 z-[300] hidden flex items-center justify-center p-6 tutorial-overlay">
        <div class="max-w-md w-full glass-panel rounded-[2.5rem] p-12 text-center border border-red-500/20 shadow-2xl">
            <div class="w-24 h-24 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-8 border border-red-500/30">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 7v4"/><path d="M12 16h.01"/><path d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10z"/></svg>
            </div>
            <h2 class="text-3xl font-luxury text-white mb-4">Sesi Terputus</h2>
            <p class="text-slate-400 text-sm leading-relaxed mb-10 text-shadow">
                Akun ini sedang digunakan di perangkat lain. <br><br>
                Sesi ini telah dinonaktifkan demi menjaga keamanan intelijen bisnis Bapak.
            </p>
            <button id="conflict-logout-btn" class="w-full py-5 rounded-2xl btn-gold uppercase tracking-[0.2em] text-xs transition-all shadow-xl">Kembali ke Login</button>
        </div>
    </div>

    <!-- TUTORIAL MODAL -->
    <div id="tutorial-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center p-6 tutorial-overlay">
        <div class="max-w-md w-full glass-panel rounded-[2rem] p-8 border border-gold/20 shadow-2xl text-left">
            <h3 class="text-xl font-luxury gold-gradient-text mb-6 text-center">Panduan Kunci AI</h3>
            <div class="space-y-4 text-sm text-slate-300 leading-relaxed">
                <div class="flex gap-4">
                    <span class="w-6 h-6 rounded-full bg-gold/20 text-gold flex items-center justify-center text-[10px] font-bold shrink-0">1</span>
                    <p>Buka <b>aistudio.google.com</b></p>
                </div>
                <div class="flex gap-4">
                    <span class="w-6 h-6 rounded-full bg-gold/20 text-gold flex items-center justify-center text-[10px] font-bold shrink-0">2</span>
                    <p>Klik <b>"Get API Key"</b> di kiri layar.</p>
                </div>
                <div class="flex gap-4">
                    <span class="w-6 h-6 rounded-full bg-gold/20 text-gold flex items-center justify-center text-[10px] font-bold shrink-0">3</span>
                    <p>Pilih <b>"Create API Key in new project"</b>.</p>
                </div>
                <div class="flex gap-4">
                    <span class="w-6 h-6 rounded-full bg-gold/20 text-gold flex items-center justify-center text-[10px] font-bold shrink-0">4</span>
                    <p>Salin kodenya & tempel di kolom login tadi.</p>
                </div>
            </div>
            <button onclick="window.toggleTutorial(false)" class="w-full mt-8 py-4 rounded-xl border border-gold/20 hover:bg-gold/10 text-gold text-xs font-bold uppercase transition-all tracking-widest text-shadow">Dimengerti, Pak!</button>
        </div>
    </div>

    <!-- DASHBOARD UTAMA -->
    <div id="main-app" class="hidden min-h-screen flex flex-col opacity-0 transition-opacity duration-1000">
        <header class="h-20 border-b border-white/5 glass-panel flex items-center px-8 sticky top-0 z-[100]">
            <div class="flex items-center gap-6 text-shadow">
                <span class="text-3xl font-luxury gold-gradient-text tracking-tighter cursor-default">MarketMind</span>
                <span class="h-4 w-px bg-white/10"></span>
                <span class="text-[9px] font-bold text-slate-500 uppercase tracking-[0.3em] mt-1">v4.1 Platinum Final</span>
            </div>
            <div class="ml-auto flex items-center gap-8 text-right">
                <div class="hidden lg:flex flex-col items-end">
                    <span class="text-[8px] font-bold text-slate-600 uppercase tracking-widest tracking-tighter">Verified CEO</span>
                    <span id="user-email-display" class="text-[10px] font-bold text-slate-400 tracking-tight"></span>
                </div>
                <button id="logout-btn" class="px-6 py-2.5 rounded-xl border border-white/5 bg-white/5 hover:bg-red-500/10 hover:text-red-400 text-[9px] font-extrabold text-slate-500 transition-all uppercase tracking-widest">Logout</button>
            </div>
        </header>

        <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
            <!-- SIDEBAR: BLUEPRINT -->
            <aside class="w-full lg:w-80 bg-black/50 border-b lg:border-b-0 lg:border-r border-white/5 p-8 overflow-y-auto z-20 shadow-2xl text-shadow">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-[10px] font-extrabold text-gold/80 uppercase tracking-[0.3em]">Business DNA</h3>
                    <button id="reset-data-btn" class="text-[9px] font-bold text-slate-600 hover:text-red-400 uppercase transition-all tracking-tighter">Hapus Semua</button>
                </div>
                <div class="space-y-6">
                    <div class="space-y-1.5">
                        <label class="text-[8px] font-bold text-slate-500 uppercase tracking-widest ml-1">Brand Bapak</label>
                        <input type="text" id="brand-name" class="w-full rounded-xl px-4 py-3 text-sm" placeholder="Contoh: Brand X" autocomplete="off">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[8px] font-bold text-slate-500 uppercase tracking-widest ml-1">Nama Produk</label>
                        <input type="text" id="product-name" class="w-full rounded-xl px-4 py-3 text-sm" placeholder="Misal: Produk Utama" autocomplete="off">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[8px] font-bold text-slate-500 uppercase tracking-widest ml-1 text-gold/80">Bidang Bisnis</label>
                        <select id="product-category" class="w-full rounded-xl px-4 py-3 text-xs cursor-pointer" onchange="window.toggleManualInput('product-category', 'manual-category')">
                            <option value="">Pilih Bidang...</option>
                            <option value="F&B (Gourmet & FoodTech)">Kuliner & Minuman</option>
                            <option value="SaaS & Digital Automation">Produk Digital / SaaS</option>
                            <option value="Sustainable Fashion">Fashion & Gaya Hidup</option>
                            <option value="Neuro-Cosmetics & Beauty">Kecantikan & Skincare</option>
                            <option value="Biohacking & Wellness">Kesehatan / Biohacking</option>
                            <option value="Professional Services">Jasa Konsultan / Agensi</option>
                            <option value="Real Estate & Smart Living">Properti / Smart Living</option>
                            <option value="manual">-- Ketik Sendiri --</option>
                        </select>
                        <input type="text" id="manual-category" class="hidden w-full rounded-xl px-4 py-3 text-sm mt-2" placeholder="Sektor Bapak apa?" autocomplete="off">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[8px] font-bold text-slate-500 uppercase tracking-widest ml-1">Gaya Brand</label>
                        <select id="brand-voice" class="w-full rounded-xl px-4 py-3 text-xs cursor-pointer">
                            <option value="Santai, Sahabat Karib, dan Humoris">Santai (Akrab)</option>
                            <option value="Profesional, Berwibawa, dan Visioner">Visioner (Wibawa)</option>
                            <option value="Misterius, Eksklusif, dan Mewah">Elite (Eksklusif)</option>
                            <option value="Berani, Radikal, dan Tegas">Radikal (Agresif)</option>
                            <option value="Empati, Hangat, dan Menenangkan">Zen (Empati)</option>
                        </select>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[8px] font-bold text-slate-500 uppercase tracking-widest ml-1">USP (Nilai Unik)*</label>
                        <textarea id="product-features" rows="4" class="w-full rounded-xl px-4 py-3 text-xs resize-none" placeholder="Kenapa orang harus beli di Bapak?"></textarea>
                    </div>
                    <div class="flex gap-3">
                        <div class="w-1/2 space-y-1.5">
                            <label class="text-[8px] font-bold text-slate-500 uppercase tracking-widest">Pricing Tier</label>
                            <select id="product-price" class="w-full rounded-xl px-3 py-3 text-[10px] cursor-pointer" onchange="window.toggleManualInput('product-price', 'manual-price')">
                                <option value="">Pilih...</option>
                                <option value="Mass / Economy">Ekonomis</option>
                                <option value="Mid-Range">Menengah (Worth it)</option>
                                <option value="Affordable Premium">Mewah Terjangkau</option>
                                <option value="Luxury / Ultra-High">Eksklusif (Mahal)</option>
                                <option value="manual">-- Manual --</option>
                            </select>
                        </div>
                        <div class="w-1/2 space-y-1.5">
                            <label class="text-[8px] font-bold text-slate-500 uppercase tracking-widest text-gold/80">Target Tribe</label>
                            <select id="product-audience" class="w-full rounded-xl px-3 py-3 text-[10px] cursor-pointer" onchange="window.toggleManualInput('product-audience', 'manual-audience')">
                                <option value="">Pilih...</option>
                                <option value="Gen Alpha & Gen Z">Masa Depan (Alpha/Z)</option>
                                <option value="Remote High-Income Nomads">Remote Professionals</option>
                                <option value="Eco-Conscious Minimalists">Minimalis Hijau</option>
                                <option value="Luxury Seekers">Pemburu Eksklusivitas</option>
                                <option value="Small Business Owners">Pemilik UMKM Modern</option>
                                <option value="manual">-- Manual --</option>
                            </select>
                        </div>
                    </div>
                    <input type="text" id="manual-price" class="hidden w-full rounded-xl px-4 py-3 text-sm mt-2" placeholder="Range harga Bapak berapa?">
                    <input type="text" id="manual-audience" class="hidden w-full rounded-xl px-4 py-3 text-sm mt-2" placeholder="Siapa yang Bapak incar?">
                </div>
            </aside>

            <!-- WORKSPACE UTAMA -->
            <main class="flex-1 p-8 overflow-y-auto bg-black relative z-10">
                <div class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-5 gap-4 mb-12" id="feature-grid"></div>

                <div id="result-panel" class="hidden glass-panel rounded-[3rem] overflow-hidden shadow-2xl border border-white/5 transition-all relative">
                    <div class="px-10 py-7 border-b border-white/5 flex flex-col sm:flex-row justify-between items-center bg-white/[0.01] gap-4">
                        <div class="flex items-center gap-4 text-shadow text-left">
                            <div class="w-2.5 h-2.5 rounded-full bg-gold shadow-[0_0_15px_rgba(212,175,55,0.6)] animate-pulse"></div>
                            <h2 id="res-title" class="text-sm font-extrabold text-white uppercase tracking-[0.4em]">Intelligence Discovery</h2>
                        </div>
                        <div class="flex items-center gap-4 w-full sm:w-auto">
                            <button id="copy-btn" class="flex-1 sm:flex-none px-6 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-[10px] font-bold uppercase border border-white/5 tracking-widest transition-all">Salin</button>
                            <button id="pdf-btn" class="flex-1 sm:flex-none btn-gold px-8 py-3 rounded-xl text-[10px] uppercase shadow-2xl tracking-[0.2em]">Simpan PDF</button>
                        </div>
                    </div>

                    <div id="res-loader" class="hidden p-32 flex flex-col items-center justify-center text-center">
                        <div class="spinner-luxury mb-10"></div>
                        <p class="text-[11px] font-extrabold text-gold/60 uppercase tracking-[0.6em] animate-pulse">Menghitung Strategi Eksekutif...</p>
                    </div>

                    <div id="res-content-wrapper" class="p-12 md:p-20 relative bg-gradient-to-b from-transparent to-[#050505] min-h-[600px]">
                        <div id="watermark" class="watermark font-luxury opacity-[0.02] select-none text-center">CONFIDENTIAL</div>
                        <div id="pdf-render">
                            <div class="pdf-page-header">
                                <div class="flex justify-between items-end text-shadow">
                                    <div>
                                        <h1 class="text-4xl font-luxury text-slate-900 tracking-tighter uppercase text-left">MarketMind Advisory</h1>
                                        <p class="text-[10px] font-extrabold text-slate-500 tracking-[0.5em] uppercase mt-3 text-left">Executive Strategic Report | Final Edition</p>
                                    </div>
                                    <p id="pdf-date" class="text-[10px] font-bold text-slate-400"></p>
                                </div>
                            </div>
                            <div id="res-body"></div>
                        </div>
                    </div>
                </div>

                <div id="empty-state" class="flex flex-col items-center justify-center py-40 text-center">
                    <div class="w-32 h-32 mb-12 bg-gold/5 rounded-full flex items-center justify-center border border-gold/10 shadow-inner relative text-shadow">
                        <div class="absolute inset-0 rounded-full border border-gold/20 animate-ping opacity-10"></div>
                        <span class="text-7xl">üíé</span>
                    </div>
                    <h2 class="text-4xl font-luxury gold-gradient-text mb-6 tracking-tight">Halo Pak CEO!</h2>
                    <p class="text-slate-500 text-base max-w-lg font-medium leading-relaxed tracking-wide">Command Center siap. Pilih dimensi analisa di atas untuk membongkar intelijen pasar Bapak.</p>
                </div>
            </main>

            <aside class="w-64 border-l border-white/5 bg-black p-8 hidden xl:block shadow-2xl overflow-y-auto z-20 text-shadow text-left">
                <h3 class="text-[9px] font-extrabold text-slate-600 uppercase tracking-[0.5em] mb-10 border-b border-white/5 pb-3">Session Log</h3>
                <div id="history-list" class="space-y-6"></div>
            </aside>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-12 left-1/2 -translate-x-1/2 glass-panel px-10 py-5 rounded-2xl border border-gold/30 text-[10px] font-extrabold uppercase tracking-[0.4em] text-gold hidden z-[400] shadow-2xl animate-bounce text-center text-shadow"></div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBU6nMB05Oe_g5U4_EvAAihbH4gWczYsPk",
            authDomain: "marketmind-a492e.firebaseapp.com",
            projectId: "marketmind-a492e",
            storageBucket: "marketmind-a492e.firebasestorage.app",
            messagingSenderId: "101258590892",
            appId: "1:101258590892:web:1015492fbc496cdd7f7d09"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const KEY_STORE = 'marketmind_pro_key';
        const SESSION_KEY = 'copygen_session_id';
        const appId = "marketmind-v4-1";

        const state = {
            apiKey: localStorage.getItem(KEY_STORE) || '',
            result: '',
            history: []
        };

        const dom = {
            login: document.getElementById('login-screen'),
            app: document.getElementById('main-app'),
            loginForm: document.getElementById('login-form'),
            loginEmail: document.getElementById('login-email'),
            loginPass: document.getElementById('login-password'),
            apiKeyIn: document.getElementById('api-key-input'),
            delKeyBtn: document.getElementById('delete-api-btn'),
            loginErr: document.getElementById('login-error'),
            loginLoad: document.getElementById('login-loader'),
            loginTxt: document.getElementById('login-text'),
            userDisp: document.getElementById('user-email-display'),
            featureGrid: document.getElementById('feature-grid'),
            resPanel: document.getElementById('result-panel'),
            resTitle: document.getElementById('res-title'),
            resLoad: document.getElementById('res-loader'),
            resBody: document.getElementById('res-body'),
            empty: document.getElementById('empty-state'),
            watermark: document.getElementById('watermark'),
            histList: document.getElementById('history-list'),
            pdfBtn: document.getElementById('pdf-btn'),
            copyBtn: document.getElementById('copy-btn'),
            resetBtn: document.getElementById('reset-data-btn'),
            toast: document.getElementById('toast'),
            tutorial: document.getElementById('tutorial-modal'),
            conflict: document.getElementById('conflict-screen'),
            conflictLogout: document.getElementById('conflict-logout-btn'),
            brand: document.getElementById('brand-name'),
            pName: document.getElementById('product-name'),
            pCat: document.getElementById('product-category'),
            pManualCat: document.getElementById('manual-category'),
            pVoice: document.getElementById('brand-voice'),
            pUSP: document.getElementById('product-features'),
            pAud: document.getElementById('product-audience'),
            pManualAud: document.getElementById('manual-audience'),
            pPrice: document.getElementById('product-price'),
            pManualPrice: document.getElementById('manual-price')
        };

        const FEATURES = {
            'market': { title: 'Peta Tribe', icon: 'üéØ', desc: 'Analisa siapa pembeli yang rela keluar uang buat Bapak? Kita bongkar perilakunya.', prompt: 'Analisa segmentasi pasar (STP) visi 2026. Jelaskan tribes mana yang paling relevan. Gunakan bahasa santai. WAJIB kasih 5 opsi contoh riil pembelinya lagi ngapain.' },
            'comp': { title: 'Intip Lawan', icon: 'üëÅÔ∏è', desc: 'Bongkar lubang di bisnis kompetitor biar Bapak bisa nikung dengan elegan.', prompt: 'Analisa kompetitor. Bongkar lubang di bisnis mereka. Kasih 5 ide konkrit cara nikung pelanggan mereka dengan cara asik di tahun 2026.' },
            'niche': { title: 'Cuan Baru', icon: 'üíé', desc: 'Cari ceruk pasar sepi pesaing tapi duitnya kenceng di tahun 2026.', prompt: 'Cari 3 ceruk pasar (Niche) unik 2026. Kasih 3 contoh ide promosi spesifik buat masing-masing ceruk agar Bapak punya pilihan.' },
            'swot': { title: 'Cek Ombal', icon: '‚öîÔ∏è', desc: 'Jujur-jujuran soal kekuatan & kelemahan brand Bapak biar gak gampang ambruk.', prompt: 'Buat analisa SWOT. Jelaskan pake perumpamaan sehari-hari. Kasih minimal 5 aksi nyata yang bisa Bapak lakuin besok pagi.' },
            'persona': { title: 'Kenalan Yuk', icon: 'üë•', desc: 'Bikin profil fiktif pembeli biar Bapak tau cara ngobrol sama mereka.', prompt: 'Bikin 2 profil orang fiktif. Ceritain masalah emosional hidup mereka dan gimana produk Bapak hadir.' },
            'content': { title: 'Ide Jualan', icon: 'üí°', desc: 'Jadwal konten 7 hari biar postingan Bapak gak ngebosenin.', prompt: 'Bikin jadwal konten viral 7 hari. Kasih judul yang menarik, isi kontennya apa, dan Hook-nya. Kasih 3 gaya konten berbeda sebagai pilihan.' },
            'seo': { title: 'Biar Ketemu', icon: 'üîç', desc: 'Bikin brand Bapak gampang nemuin pembeli di mana-mana.', prompt: 'Cariin 15 kata kunci & 20 hashtag paling viral 2026. Kasih 3 contoh caption siap pakai yang gampang dicontek.' },
            'email': { title: 'Surat Cinta', icon: '‚úâÔ∏è', desc: 'Cara ngobrol personal lewat pesan biar orang ngerasa spesial.', prompt: 'Tulis 3 variasi pesan penawaran. Satu gaya cerita, satu gaya hadiah, satu gaya to-the-point.' },
            'ads': { title: 'Iklan Cuan', icon: 'üì£', desc: 'Kata-kata iklan yang bikin orang langsung pengen klik beli.', prompt: 'Bikin 5 variasi teks iklan. Gunakan teknik psikologi 2026 tapi bahasanya ramah. Jelaskan kenapa Bapak pake kata-kata itu.' },
            'trends': { title: 'Lagi Rame Apa?', icon: 'üìà', desc: 'Tren mikro industri yang lagi anget sekarang buat numpang viral.', prompt: 'Lacak 5 tren mikro terbaru 2026. Kasih 5 cara numpang viral (trend-jacking) yang cerdik tanpa kelihatan maksa.' }
        };

        window.toggleTutorial = (show) => { dom.tutorial.classList.toggle('hidden', !show); };
        window.toggleManualInput = (selectId, manualId) => {
            const selectEl = document.getElementById(selectId);
            const manualEl = document.getElementById(manualId);
            if (selectEl.value === 'manual') { manualEl.classList.remove('hidden'); manualEl.focus(); } else { manualEl.classList.add('hidden'); }
        };

        const showToast = (msg) => {
            dom.toast.textContent = msg; dom.toast.classList.remove('hidden');
            setTimeout(() => dom.toast.classList.add('hidden'), 3500);
        };

        const updateApiUI = () => {
            if (state.apiKey) { dom.apiKeyIn.placeholder = "Kunci Terenkripsi Aktif"; dom.delKeyBtn.classList.remove('hidden'); } 
            else { dom.apiKeyIn.placeholder = "Tempel kunci AI di sini"; dom.delKeyBtn.classList.add('hidden'); }
        };

        const clearAllDataPermanent = () => {
            state.apiKey = ''; state.result = ''; state.history = [];
            dom.brand.value = ''; dom.pName.value = ''; dom.pCat.value = '';
            dom.pUSP.value = ''; dom.pAud.value = ''; dom.pPrice.value = '';
            dom.pManualCat.value = ''; dom.pManualAud.value = ''; dom.pManualPrice.value = '';
            dom.pManualCat.classList.add('hidden'); dom.pManualAud.classList.add('hidden'); dom.pManualPrice.classList.add('hidden');
            dom.pVoice.selectedIndex = 0; dom.pCat.selectedIndex = 0; dom.pPrice.selectedIndex = 0; dom.pAud.selectedIndex = 0;
            dom.loginEmail.value = ''; dom.loginPass.value = ''; dom.apiKeyIn.value = '';
            localStorage.removeItem(KEY_STORE);
            localStorage.removeItem(SESSION_KEY);
            dom.resPanel.classList.add('hidden');
            dom.empty.classList.remove('hidden');
            dom.histList.innerHTML = '';
        };

        // MONITOR SESI REAL-TIME
        let unsubSessionGlobal = null;
        onAuthStateChanged(auth, (currentUser) => {
            if (currentUser) {
                const localSessionId = localStorage.getItem(SESSION_KEY);
                const sessionRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'session', 'current');
                if (unsubSessionGlobal) unsubSessionGlobal();
                unsubSessionGlobal = onSnapshot(sessionRef, (snap) => {
                    if (snap.exists()) {
                        const serverSessionId = snap.data().sessionId;
                        if (localSessionId && serverSessionId !== localSessionId) {
                            dom.conflict.classList.remove('hidden');
                            dom.app.classList.add('blur-xl', 'pointer-events-none');
                        }
                    }
                });
                dom.login.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    dom.login.classList.add('hidden');
                    dom.app.classList.remove('hidden');
                    dom.app.classList.add('opacity-100');
                    dom.userDisp.textContent = currentUser.email;
                    
                    // PERBAIKAN: Reset tombol login saat masuk dashboard
                    dom.loginLoad.classList.add('hidden');
                    dom.loginTxt.classList.remove('hidden');
                    
                    updateApiUI();
                }, 500);
            } else {
                if (unsubSessionGlobal) unsubSessionGlobal();
                dom.app.classList.remove('opacity-100');
                dom.app.classList.add('hidden');
                dom.login.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
                
                // PERBAIKAN: Pastikan tombol login normal kembali saat logout
                dom.loginLoad.classList.add('hidden');
                dom.loginTxt.classList.remove('hidden');
                
                clearAllDataPermanent();
            }
        });

        dom.loginForm.onsubmit = async (e) => {
            e.preventDefault();
            const email = dom.loginEmail.value;
            const password = dom.loginPass.value;
            const key = dom.apiKeyIn.value.trim();
            dom.loginLoad.classList.remove('hidden');
            dom.loginTxt.classList.add('hidden');
            dom.loginErr.textContent = '';
            try {
                if (key) {
                    const validRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                    if (!validRes.ok) throw new Error("Kunci AI Salah");
                    localStorage.setItem(KEY_STORE, key);
                    state.apiKey = key;
                } else if (!localStorage.getItem(KEY_STORE)) {
                    throw new Error("Kunci AI Diperlukan");
                }
                const cred = await signInWithEmailAndPassword(auth, email, password);
                const newSessionId = crypto.randomUUID();
                localStorage.setItem(SESSION_KEY, newSessionId);
                const sessionRef = doc(db, 'artifacts', appId, 'users', cred.user.uid, 'session', 'current');
                await setDoc(sessionRef, { sessionId: newSessionId, lastActive: Date.now(), deviceName: navigator.userAgent.substring(0, 50) });
            } catch (err) {
                dom.loginErr.textContent = err.message.toUpperCase();
                dom.loginLoad.classList.add('hidden');
                dom.loginTxt.classList.remove('hidden');
            }
        };

        dom.conflictLogout.onclick = () => { signOut(auth).then(() => { dom.conflict.classList.add('hidden'); window.location.reload(); }); };
        dom.delKeyBtn.onclick = () => { if (confirm("Hapus kunci AI?")) { localStorage.removeItem(KEY_STORE); state.apiKey = ''; dom.apiKeyIn.placeholder = "Tempel kunci AI di sini"; dom.delKeyBtn.classList.add('hidden'); dom.apiKeyIn.value = ''; updateApiUI(); showToast("KUNCI AI DIHAPUS"); } };
        dom.resetBtn.onclick = (e) => { e.preventDefault(); if(confirm("Bapak yakin mau hapus semua data dan riwayat projek secara permanen?")) { clearAllDataPermanent(); showToast("DATA DIBERSIHKAN PAK!"); } };
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        const renderFeatures = () => {
            dom.featureGrid.innerHTML = Object.entries(FEATURES).map(([id, data]) => `
                <div class="relative group info-trigger-area">
                    <button onclick="window.runAnalysis('${id}')" class="w-full btn-luxury p-7 rounded-[2rem] flex flex-col items-start gap-1 transition-all relative text-left">
                        <span class="text-3xl group-hover:scale-125 transition-all mb-3 text-shadow">${data.icon}</span>
                        <span class="text-[10px] font-extrabold uppercase tracking-widest text-slate-300 text-shadow text-left">${data.title}</span>
                    </button>
                    <div class="absolute top-5 right-5 flex items-center justify-center w-5 h-5 rounded-full border border-gold/30 text-[10px] text-gold/60 cursor-help hover:bg-gold/10 hover:text-gold transition-all z-[110]">
                        i
                        <div class="info-tooltip">
                            <p class="font-bold text-gold uppercase mb-2 tracking-[0.2em] border-b border-white/10 pb-1 text-left">${data.title}</p>
                            <p class="text-slate-300 normal-case font-medium leading-relaxed">${data.desc}</p>
                            <div class="absolute bottom-full left-1/2 -translate-x-1/2 border-[8px] border-transparent border-b-black"></div>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        window.runAnalysis = async (fid) => {
            const usp = dom.pUSP.value.trim();
            if (!usp) { showToast("ISI BLUEPRINT DULU PAK!"); dom.pUSP.classList.add('ring-2', 'ring-red-500'); dom.pUSP.focus(); setTimeout(() => dom.pUSP.classList.remove('ring-2', 'ring-red-500'), 2500); return; }
            let fCat = dom.pCat.value === 'manual' ? dom.pManualCat.value : dom.pCat.value;
            let fAud = dom.pAud.value === 'manual' ? dom.pManualAud.value : dom.pAud.value;
            let fPrice = dom.pPrice.value === 'manual' ? dom.pManualPrice.value : dom.pPrice.value;
            const meta = { brand: dom.brand.value || "Bisnis Bapak", name: dom.pName.value, cat: fCat || "Pasar", voice: dom.pVoice.value, aud: fAud || "Konsumen", price: fPrice || "Custom" };
            dom.empty.classList.add('hidden'); dom.resPanel.classList.remove('hidden');
            dom.resTitle.textContent = `${FEATURES[fid].title} | ${meta.brand}`;
            dom.resLoad.classList.remove('hidden'); dom.resBody.innerHTML = '';
            dom.resPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });

            const sys = `Kamu adalah Senior Marketing Strategist Sahabat CEO. 
            GAYA: Super simpel, santai, asik. Hindari bahasa ribet. Pakai analogi keseharian.
            KEWAJIBAN: 
            1. Tiap poin WAJIB kasih minimal 3-5 CONTOH RIIL yang sangat spesifik. 
            2. DI AKHIR LAPORAN, WAJIB BERIKAN BAGIAN:
               - **"üöÄ RANGKUMAN STRATEGI"**: Intisari dari apa yang harus Bapak lakukan pertama kali.
               - **"‚úÖ DAMPAK POSITIF"**: Jelaskan secara gamblang keuntungan nyata apa yang akan Bapak dapat jika strategi ini dijalankan.
            TUJUAN: Agar Bapak yakin, percaya diri, dan langsung tahu apa hasil akhirnya.
            TARGET: Siap praktek hari ini. FORMAT: Markdown mewah.`;
            
            const user = `UNIT: ${meta.name} (${meta.cat}). BRAND: ${meta.brand}. USP: ${usp}. TARGET: ${meta.aud}. HARGA: ${meta.price}. TUGAS: ${FEATURES[fid].prompt}`;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`;
                const body = { contents: [{ parts: [{ text: user }] }], systemInstruction: { parts: [{ text: sys }] }, generationConfig: { temperature: 0.85 } };
                const res = await fetch(url, { method: 'POST', body: JSON.stringify(body) });
                const json = await res.json();
                if (!res.ok) throw new Error(json.error?.message);
                const text = json.candidates[0].content.parts[0].text;
                state.result = text; dom.resBody.innerHTML = marked.parse(text);
                const hItem = { fid, brand: meta.brand, time: new Date().toLocaleTimeString(), text };
                state.history.unshift(hItem); if (state.history.length > 25) state.history.pop();
                dom.histList.innerHTML = state.history.map((h, i) => `
                    <div onclick="window.loadHist(${i})" class="p-5 rounded-2xl bg-white/[0.02] border border-white/5 hover:border-gold/40 cursor-pointer transition-all">
                        <p class="text-[8px] font-extrabold text-gold uppercase mb-1 tracking-[0.2em]">${FEATURES[h.fid].title}</p>
                        <p class="text-[11px] font-bold text-slate-400 truncate">${h.brand}</p>
                        <p class="text-[7px] text-slate-600 mt-2 uppercase tracking-widest">${h.time}</p>
                    </div>
                `).join('');
            } catch (err) { dom.resBody.innerHTML = `<div class="p-8 text-red-500 text-center font-bold text-xs uppercase tracking-widest text-shadow">Gagal Pak: ${err.message}</div>`; } finally { dom.resLoad.classList.add('hidden'); }
        };

        window.loadHist = (i) => {
            const h = state.history[i];
            dom.resTitle.textContent = `${FEATURES[h.fid].title} (Arsip)`;
            dom.resBody.innerHTML = marked.parse(h.text);
            state.result = h.text; dom.resPanel.classList.remove('hidden');
            dom.empty.classList.add('hidden'); dom.resPanel.scrollIntoView({ behavior: 'smooth' });
        };

        dom.pdfBtn.onclick = () => {
            if (!state.result) return;
            const bName = dom.brand.value || "Laporan_CEO";
            dom.watermark.textContent = bName; dom.watermark.classList.remove('hidden');
            document.getElementById('pdf-date').textContent = new Date().toLocaleDateString('id-ID', { dateStyle: 'full' });
            const head = document.querySelector('.pdf-page-header'); head.style.display = 'block';
            const originalColor = dom.resBody.style.color; dom.resBody.style.color = '#000';
            const opt = { margin: 15, filename: `MARKETMIND_REPORT_${bName.replace(/\s+/g, '_')}.pdf`, html2canvas: { scale: 2.5 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().set(opt).from(document.getElementById('pdf-render')).save().then(() => { head.style.display = 'none'; dom.watermark.classList.add('hidden'); dom.resBody.style.color = originalColor; });
        };

        dom.copyBtn.onclick = () => { if (state.result) { navigator.clipboard.writeText(state.result).then(() => showToast("OK PAK, SUDAH DISALIN!")); } };

        renderFeatures();
    </script>
</body>
</html>